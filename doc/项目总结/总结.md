# 项目三总结-LeafMall

## 使用技术栈

- Spring Cloud
- Mysql
- Redis
- ElasticSearch
- RocketMQ
- Canal
- Mybatis-plus
- Nacos
- Minio
- docker

## 包含功能

- 后台、商品详情、搜索、登录、购物车、订单、支付、秒杀

# 功能技术详解

## 后台

- 对分类，平台属性，品牌列表，分类品牌进行 增删改查
- SPU进行增删改查
- SKU进行增删改查
- 图片上传至minio

### 技术点

- 使用mybatis进行联表查询
- 使用mybatis-plus自带查询，实现简单查询，也可在mapper接口中写默认方法，方便查询的复用与管理
- 使用minio官方sdk进行图片的增删改查
- 对象存储的要素：桶，对象，对象名，权限
- MapStruct进行实体类的转换

### 问题

- 难以理清各个表之间的关系，可使用ER图，并结合业务需求理解

## 商品详情

- 展示spu与所选sku的信息

### 技术点

- 使用mybatis-plus分别查询多表
- 使用redis缓存sku信息，减少mysql的压力
- 使用Canal+RocketMQ失效redis缓存

## 问题

- 缓存引起的问题
  - 缓存的击穿
    - 即 访问数据库存在，缓存还没储存的，当为热点数据时，可能会导致数据库崩溃
    - 使用Redission增加分布式互斥锁也可以使用setnx，让只访问数据库一次
    - 可使用双重检测在 互斥锁中
  - 缓存的穿透
    - 即 访问数据库中没有的数据，穿透了缓存层
    - 使用布隆过滤器(本次使用Redis中的bitmap)，判断数据库中是否有该数据，没有则立即返回
      - 布隆过滤器: 即通过多个hash函数将其散列至bitmap中，判断是否都存在，关键值是长度和错误率
  - 缓存的雪崩
    - 即 缓存在同一时间失效，导致直接请求数据库
    - 不要设置统一的过期时间，可在设置随机的过期时间
  - 缓存与数据库的一致性
    - 对应高一致性的 值，不要使用缓存
    - 使用Canal对mysql进行模拟主从备份，当增删改时给MQ发送消息，保证100%可达
    - 服务订阅MQ中Canal的消息，更具获取的信息，失效缓存

## 搜索

- 更具sku的不同信息与关键词，进行全文检索

### 技术点

 - ElasticSearch的增删改查
   - 分为：index、doc,文档为索引储存的基本单位，与mysql中表与元组的关系一样

### 问题

- ElasticSearch查询语句的构建，通过Resuful接口查询，即写Json
- 可ES-Java使用Lambda风格来构建json

## 登录

- 简单的登录与注册

### 技术点

使用Redis储存登录token，共享登录信息，监控登录状态

### 问题

-  需要多次访问 Redis，并强耦合，可使用JWT

## 购物车

### 功能

- 购物车的增删改查

### 技术点

- 因为mysql增删改效率较差，直接使用Redis存储购物车信息，提高并发量

## 订单

### 功能

- 实现在购物车中下单的功能，以及订单超时关闭功能

### 技术点

- 使用RocketMQ发送延迟消息，实现订单超时关闭

## 支付

### 功能

- 接入第三方支付，这里使用支付宝

### 技术点

- 使用支付宝sdk，跳转支付页面
- 使用同步和异步回调，获取当前支付状态

### 问题

- 建议使用状态机，来改变订单的状态

## 秒杀

### 功能

- 在秒杀活动中，能应对高并发的特殊Service
- 秒杀列表，秒杀详情页，抢购排队，秒杀商品确认页
- 库存限制、时间限制、购买量限制

### 技术点

- 提前预热redis缓存，可在每天凌晨将秒杀商品信息存储至缓存中，解决秒杀列表和详情页的高并发
- 使用rocketMQ实现抢购排序，限流削峰
- 使用redis中list防止库存超卖
- 使用本地缓存库存位，达到快速拒绝，防止重复访问redis
- 在redis记录下单情况标记，现在购买量的限制
